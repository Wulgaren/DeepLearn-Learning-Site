#!/usr/bin/env node
/**
 * After Vite build + copy-css, read dist/site.css and write
 * netlify/edge-functions/lib/critical-css.ts so the no-JS layout can inline
 * CSS. This fixes browsers (e.g. Kindle) that don't load external stylesheets.
 */
import { readFileSync, writeFileSync, existsSync } from "fs";
import { join } from "path";

const distSiteCss = join(process.cwd(), "dist", "site.css");
const outPath = join(process.cwd(), "netlify", "edge-functions", "lib", "critical-css.ts");

if (!existsSync(distSiteCss)) {
  console.warn("inline-critical-css: dist/site.css not found, skipping");
  process.exit(0);
}

const css = readFileSync(distSiteCss, "utf8");
// Avoid closing the inline <style> tag (e.g. if CSS contains "</style>" in a string)
let escaped = css.replace(/<\/style>/gi, "<\\u002fstyle>");
// Escape for use inside a template literal: \ ` $ need escaping
escaped = escaped.replace(/\\/g, "\\\\").replace(/`/g, "\\`").replace(/\$/g, "\\$");
const ts = `/** Generated by scripts/inline-critical-css.mjs - do not edit manually */\nexport const criticalCss = \`${escaped}\`;\n`;

writeFileSync(outPath, ts, "utf8");
console.log("inline-critical-css: wrote", outPath);
